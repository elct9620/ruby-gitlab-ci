include:
  - remote: https://github.com/elct9620/ruby-gitlab-ci/raw/main/common.yml#ruby.yml

variables:
  RUBY_VERSION: 3.0.3
  CUCUMBER_PUBLISH_QUIET: true

rubygems:
  extends: .ruby
  stage: prepare
  script:
    - bundle install
  retry:
    max: 1
  cache:
    - key: !reference [.ruby-cache, key]
      paths: !reference [.ruby-cache, paths]
      policy: pull-push

rubocop:
  extends: .ruby
  stage: lint
  needs: ["rubygems"]
  script:
    - bundle exec rubocop
  rules:
    - exists:
      - .rubocop.yml

bundler-audit:
  extends: .ruby
  stage: lint
  before_script:
    - gem install bundler-audit
    - bundle audit --update
  script:
    - bundle audit

bundler-leak:
  extends: .ruby
  stage: lint
  before_script:
    - gem install bundler-leak
    - bundle leak check --update
  script:
    - bundle leak

rspec:
  extends: .ruby
  stage: test
  needs: ["rubygems"]
  script:
    - if [[ "$RSPEC_JUNIT_REPORT" == "yes" ]]; then bundle exec rspec --format progress --format RspecJunitFormatter --out rspec.xml; else bundle exec rspec; fi
  artifacts:
    paths:
      - coverage
      - rspec.xml
    reports:
      junit: rspec.xml
      cobertura: coverage/coverage.xml
  coverage: '/\(\d+.\d+%\)/'
  rules:
    - exists:
      - spec/spec_helper.rb

cucumber:
  extends: .ruby
  stage: test
  needs: ["rubygems"]
  script:
    - bundle exec cucumber -f junit -o tmp/cucumber
  artifacts:
    paths:
      - coverage
    reports:
      junit: tmp/cucumber/**/TEST-*.xml
      cobertura: coverage/coverage.xml
  coverage: '/\(\d+.\d+%\)/'
  rules:
    - exists:
      - features/support/env.rb
