include:
  - remote: https://github.com/elct9620/ruby-gitlab-ci/raw/main/ruby.yml
  - remote: https://github.com/elct9620/ruby-gitlab-ci/raw/main/javascript.yml
  - remote: https://github.com/elct9620/ruby-gitlab-ci/raw/main/docker.yml#rails.yml

variables:
  POSTGRES_VERSION: 12-alpine
  POSTGRES_DB: application
  POSTGRES_PASSWORD: postgres
  DATABASE_URL: "postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/$POSTGRES_DB"

brakeman:
  image: registry.gitlab.com/gitlab-org/security-products/analyzers/brakeman:2
  stage: lint
  script:
    - /analyzer run
  artifacts:
    reports:
      sast: gl-sast-report.json

rspec:
  extends: .rails
  services:
    - "postgres:$POSTGRES_VERSION"
  variables:
    RAILS_ENV: test
  before_script:
    - !reference [.install_node]
    - !reference [.ruby, before_script]
    - bundle exec rake db:migrate

assets:precompile:
  extends: .rails
  stage: compile
  services:
    - "postgres:$POSTGRES_VERSION"
  variables:
    RAILS_ENV: production
  script:
    - RAILS_MASTER_KEY=${RAILS_PRODUCTION_KEY:-$RAILS_MASTER_KEY} bundle exec rails assets:precompile
  retry:
    max: 1
  artifacts:
    paths:
      - public/packs
      - public/assets
  rules:
    - if: '$ASSETS_PRECOMPILE == "yes"'

assets:s3:
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  stage: deploy
  before_script:
    - if [[ -v S3_ENDPOINT ]]; then export AWS_EXTRA_OPTIONS="${AWS_EXTRA_OPTIONS} --endpoint-url ${S3_ENDPOINT}"; fi
    - if [[ -v S3_ACCESS_KEY_ID ]]; then export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID; fi
    - if [[ -v S3_SECRET_ACCESS_KEY ]]; then export AWS_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY; fi
  script:
    - aws $AWS_EXTRA_OPTIONS s3 sync ./public s3://$S3_BUCKET --cache-control "public, max-age=31536000"
  needs:
    - job: assets:precompile
      artifacts: true
  rules:
    - if: '$ASSETS_PRECOMPILE == "yes" && $UPLOAD_TO_S3 == "yes"'
