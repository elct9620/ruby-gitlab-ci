include:
  remote: https://github.com/elct9620/ruby-gitlab-ci/raw/main/common.yml#docker.yml

variables:
  DOCKER_BUILDX_VERSION: 0.8.2
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

.docker:base:
  extends: .docker
  variables:
    REVISION: $CI_COMMIT_SHORT_SHA
  script:
    - export DOCKER_TAG_OPTIONS="--tag ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG} --tag ${IMAGE_NAME}:${IMAGE_TAG}"
    - if [ "$LATEST_IMAGE" == "yes" ]; then export DOCKER_TAG_OPTIONS="--tag ${IMAGE_NAME}:latest ${DOCKER_TAG_OPTIONS}"; fi
    - docker buildx create --use # Enable cache export support
    - docker buildx build
      --cache-from type=local,src=tmp/docker
      --cache-to type=local,dest=tmp/docker
      --build-arg REVISION=${REVISION}
      ${DOCKER_TAG_OPTIONS}
      --push .
  cache:
    key:
      files:
        - Gemfile.lock
      prefix: $CI_JOB_NAME
    paths:
      - tmp/docker

docker:
  extends: .docker:base
  stage: build
  retry:
    max: 1
  rules:
    - if: '$DOCKER_ENABLED == "yes" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      variables:
        LATEST_IMAGE: 'yes'
    - if: '$DOCKER_ENABLED == "yes" && $CI_COMMIT_TAG'
      variables:
        REVISION: $CI_COMMIT_TAG
    - if: '$DOCKER_ENABLED == "yes"'

trivy:
  extends: .docker
  stage: scan
  variables:
    # Exclude built-in rubygems
    TRIVY_OPTIONS: --skip-dirs /usr/local/lib/ruby/gems
  cache:
    key: trivy-shared
    paths:
      - .trivycache/
  needs:
    - docker
  script:
    - export TRIVY_VERSION=$(wget -qO - "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
    - echo $TRIVY_VERSION
    - wget --no-verbose https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz -O - | tar -zxvf -
    # Build report
    - ./trivy --cache-dir .trivycache/ image --exit-code 0 --no-progress --format template --template "@contrib/gitlab.tpl" -o gl-container-scanning-report.json $IMAGE_NAME:$IMAGE_TAG
    # Print report
    - ./trivy --cache-dir .trivycache/ image --exit-code 0 --no-progress --severity HIGH $IMAGE_NAME:$IMAGE_TAG
    # Fail on severe vulnerabilities
    - ./trivy --cache-dir .trivycache/ image $TRIVY_OPTIONS --exit-code 1 --severity CRITICAL --no-progress --ignore-unfixed $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  rules:
    - if: '$TRIVY_ENABLED == "yes" && $DOCKER_ENABLED == "yes"'
    - if: '$TRIVY_ENABLED == "yes" && $DOCKER_ENABLED == "yes" && $CI_COMMIT_TAG'
